<?php
/**
 * @file
 * Code for the Sprowt Paragraphs feature.
 */

include_once 'sprowt_paragraphs.features.inc';


/**
 * Implements hook_theme().
 */
function sprowt_paragraphs_theme($existing, $type, $theme, $path)
{
    return array(
        'field__field_header__paragraphs_item' => array (
            'template' => 'field--field-header--paragraphs-item',
            'path' => $path . '/theme',
            'base hook' => 'field',
        ),
        'field__field_content' => array (
            'template' => 'field--field-content',
            'path' => $path . '/theme',
            'base hook' => 'field',
        ),
    );
}

/**
 * Implements hook_preprocess_entity().
 */
function sprowt_paragraphs_preprocess_entity(&$variables)
{
    if ($variables['entity_type'] == 'paragraphs_item') {
        $custom_class = field_get_items('paragraphs_item', $variables['elements']['#entity'], 'field_custom_class');
        if(!empty($custom_class)) {
            foreach($custom_class as $class) {
                $classes = explode(' ', $class['value']);
                $new_classes_array = array_merge($variables['classes_array'], $classes);
                $variables['classes_array'] = $new_classes_array;
                $variables['attributes_array']['class'] = $new_classes_array;
            }
        }
    }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function sprowt_paragraphs_preprocess_field(&$variables)
{
    $element = $variables['element'];

    if($element['#field_name'] == 'field_content') {
        $items = $variables['items'];
        $variables['items_classes_array'] = array();
        foreach($items as $delta => $item) {
            $classes = array(
                'field__item'
            );
            $classes[] = ($delta + 1) % 2 ? 'odd' : 'even';
            foreach($item['entity']['paragraphs_item'] as $paragraph) {
                $custom_class = field_get_items('paragraphs_item', $paragraph['#entity'], 'field_custom_class');
                if (!empty($custom_class)) {
                    foreach ($custom_class as $class) {
                        $custom_class_array = explode(' ', $class['value']);
                        foreach ($custom_class_array as $class) {
                            $classes[] = trim($class) . "--wrap";
                        }
                    }
                }

                $bundle = $paragraph['#bundle'];
                $wrap_class = 'paragraphs-item-' . drupal_clean_css_identifier($bundle);
                $classes[] = $wrap_class . '--wrap';
            }

            $variables['items_classes_array'][$delta] = $classes;
        }
    }
}

/**
 * Implements hook_form_alter().
 */
function sprowt_paragraphs_form_alter(&$form, &$form_state, $form_id)
{
    if($form['#node_edit_form']) {
        drupal_add_js(drupal_get_path('module', 'sprowt_paragraphs') . '/js/image_annotator_fix.js');
    }
}